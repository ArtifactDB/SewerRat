# Collecting random shit from a shared filesystem

## Introduction

SewerRat retrieves user-supplied metadata from a shared filesystem and indexes them into a giant SQLite file.
This allows users to easily search for files of interest generated by other users, typically in high performance computing (HPC) clusters associated with the shared filesystem.
The aim is to promote discovery of analysis artifacts in an ergonomic manner -
we do not require uploads to an external service,
we do not impose schemas on the metadata format,
and we re-use the existing storage facilities on the HPC cluster.
SewerRat can be considered a much more relaxed version of the [Gobbler](https://github.com/ArtifactDB/gobbler) that federates the storage across users.

## Registering a directory

Any directory can be indexed as long as (i) the requesting user has write access to it and (ii) the account running the SewerRat service has read access to it.
To demonstrate, let's make a directory containing JSON-formatted metadata documents.
Other files may be present, of course, but SewerRat only cares about the metadata.
Metadata files can be anywhere in this directory (including within subdirectories) and they can have any base name (here, `A.json` and `B.json`).

```shell
mkdir test 
echo '{ "title": "YAY", "description": "whee" }' > test/A.json
mkdir test/sub
echo '{ "authors": { "first": "Aaron", "last": "Lun" } }' > test/sub/A.json
echo '{ "foo": "bar", "gunk": [ "stuff", "blah" ] }' > test/sub/B.json
```

We define some small utility functions from [`scripts/functions.sh`](scripts/functions.sh) to perform the registration.
This is best placed in our `.bash_profile` so that we don't need to do this every time.
These functions are pretty simple and it should be trivial to define equivalents in any programming framework like R or Python.

```shell
export SEWER_RAT_URL=<INSERT URL HERE> # get this from the SewerRat admin.
source scripts/functions.sh
```

Once this is done, we can register our directory by calling the `registerSewerRat` function.
This requires a path to the directory along with a comma-separated list of file names to be indexed from that directory.

```shell
registerSewerRat test A.json,B.json
```

The registration process will walk recursively through the specified directory, indexing all files named `A.json` and `B.json`. 
We can then perform some complex searches on the contents of these files (see [below](#querying-the-index)).
There is no limit on the number of times that a directory can be registered, though every new registration will replace all previously-registered files from that directory.

The SewerRat will periodically (by default, daily) update the index by examining all paths to metadata files in its registry.
If we modified one of our files, the SewerRat will re-index that file; and if we deleted a file, the SewerRat will remove it from the index.
This ensures that the information in the index reflects the organization on the filesystem.
Note that the SewerRat will not index new files that were added to a directory after registration.
If we want these files in the index, we'll have to re-register the directory.

To remove files from the registry, we call the `deregisterSewerRat` function from [`scripts/functions.sh`](scripts/functions.sh).
This will remove all files in the registry that were previously registered from the specified directory.
Note that, if the directory no longer exists, the normalized absolute path should be supplied to `deregisterSewerRat`.
(Or we could just wait for the periodic updates to remove those paths automatically.)

```shell
deregisterSewerRat test
```

## Querying the index

## For developers

Clone this repository and build the binary:

```shell
git clone https://github.com/ArtifactDB/SewerRat
cd SewerRat
go build
```

And then run SewerRat.
The `-db` flag specifies the location of the SQLite file, 
`-scratch` specifies the scratch directory for storing verification codes, 
and `-port` is the port we're listening to for requests (e.g., 8080).

```shell
./SewerRat -db DBPATH -scratch SCRATCH -port PORT
```

Any existing file at `DBPATH` will be used, so the SewerRat can be easily restarted with the same database.

The SewerRat will periodically (by default, daily) create a back-up of the index at `DBPATH.backup`.
This can be used to manually recover from problems with the SQLite database by copying the backup to `DBPATH` and restarting the SewerRat.
